editors:
  - version: trunk
  - version: 2021.1
  - version: 2020.3
os_versions:
  - version: 10.14
    type: Unity::metal::macmini
    image: slough-ops/macos-10.14-xcode:stable
    flavor: m1.mac
  - version: 10.15
    type: Unity::VM::osx
    image: desktop/unity-macos-10.15-xcode-12.2:stable
    flavor: m1.mac

---

{% for editor in editors %}
{% for os_version in os_versions %}

Build_Test_Player_OSX_{{os_version.version}}_{{ editor.version }}:
  name: Build_Test_Player_OSX_{{os_version.version}} on version {{ editor.version }}
  agent:
    type: {{ os_version.type }}
    image: {{ os_version.image }}
    flavor: {{ os_version.flavor }}
  commands:
    - brew tap --force-auto-update unity/unity git@github.cds.internal.unity3d.com:unity/homebrew-unity.git
    - brew install unity/unity/unity-downloader-cli
    - unity-downloader-cli -u {{editor.version}} -c editor -c il2cpp  --wait --published-only
    - .Editor/Unity.app/Contents/MacOS/Unity -batchmode -nographics -projectPath . -buildOSXUniversalPlayer player/player.app -logfile Unity.log -quit
  artifacts:
    player: 
      paths:
        - player/**
    logs:
      paths:
        - Unity.log

{% endfor %}
{% endfor %}

Build_All_Test_Players_OSX_Metal:
  name: Build all test players OSX Metal
  dependencies:
  {% for editor in editors %}
  {% for os_version in os_versions %}
  - path: .yamato/build_test_player-OSX-Metal.yml#Build_Test_Player_OSX_{{os_version.version}}_{{ editor.version }}
    rerun: always
  {% endfor %}
  {% endfor %}
